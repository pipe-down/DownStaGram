<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<head>
  <link href="/css/main.css" rel="stylesheet" type="text/css" />
</head>
<style>
  .fieldError {
    border-color: #bd2130;
  }
</style>
<body>
    <head th:replace="fragments/bodyHeader :: bodyHeader" />
    <!-- main -->
    <main>
      <div class="feeds">
        <!-- article -->
        <div th:each="row, index : ${posts}">
          <article>
            <header>
              <div class="profile-of-article">
                <img class="img-profile pic" th:if="${user.profileImg != null}" th:src="'/img/profile/'+ ${row.user.profileImg}" th:alt="${row.user.name}+'ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„'">
                <img class="img-profile pic" th:unless="${user.profileImg != null}" src="/img/profile04.png" th:alt="${row.user.name}+'ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„'">

                <span class="userID main-id point-span" th:text="${row.user.name}"></span>
              </div>
              <img class="icon-react icon-more" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/more.png" alt="more">
            </header>
            <div class="main-image">
              <img th:src="'/img/feed/'+ ${row.user.userId} + '/' + ${row.postImages[0].imagePath}" th:alt="${row.user.name}+'ë‹˜ì˜ í”¼ë“œ ì‚¬ì§„'" class="mainPic">
            </div>
            <div class="icons-react">
              <div class="icons-left">
                <div class="like" th:id="'like'+${row.id}">
                </div>
                <img class="icon-react" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/comment.png" alt="ë§í’ì„ ">
                <img class="icon-react" src="/img/dm.png" alt="DM">
              </div>
              <img class="icon-react" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/bookmark.png" alt="ë¶ë§ˆí¬">
            </div>
            <!-- article text data -->
            <div class="reaction">
              <div class="liked-people" th:id="'liked-people'+${row.id}">
              </div>
              <div class="description">
                <p><span class="point-span userID">dlwlrma</span><span class="at-tag">@lal.jh @gucci</span> ğŸŒ±</p>
              </div>
              <div th:class="'comment-section'+${row.id}">
              </div>
            </div>
            <div class="hl"></div>
            <form th:name="'commentForm'+${row.id}" th:onsubmit="'commentInsert('+${row.id}+')'">
              <div class="comment">
                <input type="hidden" name="pid" id="pid" th:value="${row.id}" />
                <input type="hidden" name="uid" id="uid" th:value="${user.id}" />
                <input th:id="${index.index}" class="input-comment" name="content" type="text" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." >
                <button type="submit" th:id="'submit-comment'+${row.id}" class="submit-comment" disabled>ê²Œì‹œ</button>
              </div>
            </form>
          </article>
        </div>
      </div>
      <!-- main-right -->
      <div class="main-right">
        <div class="myProfile">
          <img class="pic" th:if="${user.profileImg != null}" th:src="'/img/profile/'+ ${user.profileImg}" th:alt="${user.name}+'ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„'">
          <img class="pic" th:unless="${user.profileImg != null}" src="/img/profile04.png" th:alt="${user.name}+'ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„'">
          <div>
            <span class="userID point-span" th:text="${user.userId}"></span>
            <span class="sub-span" th:text="${user.name}"></span>
          </div>
        </div>
        <!-- story section -->
        <div class="section-story">
          <div class="menu-title">
            <span class="sub-title">ìŠ¤í† ë¦¬</span>
            <span class="find-more">ëª¨ë‘ ë³´ê¸°</span>
          </div>
          <ul class="story-list">
            <li>
              <div class="gradient-wrap">
                <img class="img-profile story" src="/img/a1.jpg" alt="test1ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
              </div>
              <div class="profile-text">
                <span class="userID point-span">test1</span>
                <span class="sub-span">8ë¶„ ì „</span>
              </div>
            </li>
            <li>
              <div class="gradient-wrap">
                <img class="img-profile story" src="/img/a2.jpg" alt="test2ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
              </div>
              <div class="profile-text">
                <span class="userID point-span">test2</span>
                <span class="sub-span">30ë¶„ ì „</span>
              </div>
            </li>
            <li>
              <div class="gradient-wrap">
                <img class="img-profile story" src="/img/a3.jpg" alt="test4ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
              </div>
              <div class="profile-text">
                <span class="userID point-span">test4</span>
                <span class="sub-span">33ë¶„ ì „</span>
              </div>
            </li>
            <li>
              <div class="gradient-wrap">
                <img class="img-profile story" src="/img/a4.jpg" alt="test5ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
              </div>
              <div class="profile-text">
                <span class="userID point-span">test5</span>
                <span class="sub-span">46ë¶„ ì „</span>
              </div>
            </li>
          </ul>
        </div>
        <!-- recommendation section -->
        <div class="section-recommend">
          <div class="menu-title">
            <span class="sub-title">íšŒì›ë‹˜ì„ ìœ„í•œ ì¶”ì²œ</span>
            <span class="find-more">ëª¨ë‘ ë³´ê¸°</span>
          </div>
          <ul class="recommend-list">
            <li>
              <div class="recommend-friend-profile">
                <img class="img-profile" src="/img/profile03.png" alt="renebaebaeë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
                <div class="profile-text">
                  <span class="userID point-span">jongsuk0206</span>
                  <span class="sub-span">taeyeon_ssë‹˜ ì™¸ 5ëª…ì´ íŒ”ë¡œìš°í•©ë‹ˆë‹¤</span>
                </div>
              </div>
              <span class="btn-follow">íŒ”ë¡œìš°</span>
            </li>
            <li>
              <div class="recommend-friend-profile">
                <img class="img-profile" src="/img/profile02.png" alt="_jeongjaehyunë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
                <div class="profile-text">
                  <span class="userID point-span">hi_sseulgi</span>
                  <span class="sub-span">heybibleeë‹˜ì´ íŒ”ë¡œìš°í•©ë‹ˆë‹¤</span>
                </div>
              </div>
              <span class="btn-follow">íŒ”ë¡œìš°</span>
            </li>
            <li>
              <div class="recommend-friend-profile">
                <img class="img-profile" src="/img/profile04.png" alt="leehi_hië‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„">
                <div class="profile-text">
                  <span class="userID point-span">skawngur</span>
                  <span class="sub-span">soohyun_k216ë‹˜ ì™¸ 8ëª…ì´ íŒ”ë¡œìš°í•©...</span>
                </div>
              </div>
              <span class="btn-follow">íŒ”ë¡œìš°</span>
            </li>
          </ul>
        </div>
        <footer>
          <p class="insta-sccript">
            ì†Œê°œ âˆ™ ë„ì›€ë§ âˆ™ í™ë³´ ì„¼í„° âˆ™ API âˆ™ ì±„ìš© ì •ë³´ âˆ™ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ âˆ™ <br>ì•½ê´€ âˆ™ ìœ„ì¹˜ âˆ™ ì¸ê¸°ê³„ì • âˆ™ í•´ì‹œíƒœê·¸ âˆ™ ì–¸ì–´
            <br><br>
            Â© 2021 DOWNSTAGRAM FROM PIPE-DOWN
          </p>
        </footer>
      </div>
    </main>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script th:inline="javascript">

      $(document).ready(function() {
        likeview();
        commentview();
      });

      function commentview() {
        /*<![CDATA[*/
        var testValue = [[${posts}]];
        for(var i=0; i<testValue.content.length; i++) {
          let postId = testValue.content[i].id;
          let uId = [[${user.id}]];
          $.ajax({
            url : '/comment/list',
            type:'get',
            data : {'id': postId},
            success : function(data){
              var a = '';
              $.each(data, function(key, value){
                var userid = value.user.id;
                var date = value.createdDate;
                var wd = new Date(date.valueOf());
                var w_time = wd.getTime();

                var cur = new Date();
                var c_time = cur.getTime();

                var chai = c_time - w_time;

                a += '<ul class="comments">';

                a += '<li><span><span class="point-span userID">'+value.user.userId+'</span>'+value.content+'</span><div>';

                if(uId == userid) {
                  a += '<a onclick="commentDelete('+ value.id +');">' // likeInsertëŠ” ë°‘ì—ì„œ
                  a += '<img class="comment-more" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/more.png" alt="more"></a>';
                }


                a += '<div class="comment-like">';
                a += '<img class="comment-heart" src="/img/like.png" alt="í•˜íŠ¸">';
                a += '<img class="comment-heart-liked" src="/img/liked.png" alt="ì¢‹ì•„ìš”ëœí•˜íŠ¸">';
                a += '</div></div></li></ul>';

                a += '<div class="time-log"><span>';
                if(chai < 1000 * 60)
                  a += Math.floor(chai / 1000) + ' ì´ˆì „';
                else if(chai < 1000 * 60 * 60)
                  a += Math.floor(chai / (1000 * 60)) + ' ë¶„ì „';
                else if(chai < 1000 * 60 * 60 * 24)
                  a += Math.floor(chai / (1000 * 60 * 60)) + ' ì‹œê°„ì „';
                else if(chai < 1000 * 60 * 60 * 24 * 30)
                  a += Math.floor(chai / (1000 * 60 * 60 * 24)) + ' ì¼ì „';
                else if(chai < 1000 * 60 * 60 * 24 * 30 * 12)
                  a += Math.floor(chai / (1000 * 60 * 60 * 24 * 30)) + ' ë‹¬ì „';
                a += '</span></div>';

              });
              $(".comment-section" + postId).html(a);
            }
          });
        }
        /*]]>*/
      }

      //ëŒ“ê¸€ ë“±ë¡
      function commentInsert(pid){
        var insertData = $("[name=commentForm" + pid +"]").serialize();
        $.ajax({
          url : '/comment/insert',
          type : 'post',
          data : insertData,
          success : function(data){
            if(data == 1) {
              commentview();
            }
          }
        });
      }

      function commentDelete(cmt){
        var msg = "ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
        if (confirm(msg)) {
          $.ajax({
            url : '/comment/delete/' + cmt,
            type : 'post',
            success : function(data){
              if(data == 1)
                commentview();
            }
          });
        }
      }

      function likeview() {
        /*<![CDATA[*/
        var testValue = [[${posts}]];
        for(var i=0; i<testValue.content.length; i++) {
          let postId = testValue.content[i].id;
          $.ajax({
            url: "/like/view",
            type: "GET",
            data: {'id' : postId },
          })
                  .done(function (fragment) {
                    let a = '';
                    let b = '';
                    if (fragment.cnt == 1) {   // í˜„ì¬ ë¡œê·¸ì¸ ìœ ì €ê°€ í¬ìŠ¤íŒ… ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŒ
                      a += '<a onclick="likeDelete('+ postId +');"' // likeDeleteëŠ” ë°‘ì—ì„œ
                              + 'class="heartIcon" aria-hidden="true">'
                              + '<img class="icon-react" src="/img/liked.png" alt="í•˜íŠ¸" style="cursor:pointer;"></a>'
                    } else if (fragment.cnt == 0) { // ì•ˆëˆŒë €ìŒ
                      a += '<a onclick="likeInsert('+ postId +');"' // likeInsertëŠ” ë°‘ì—ì„œ
                              + 'class="heartIcon" aria-hidden="true">'
                              + '<img class="icon-react" src="/img/like.png" alt="í•˜íŠ¸" style="cursor:pointer;"></a>'
                    }

                    $("#like" + postId).html(a);

                    if(fragment.total_cnt==1) {
                      b += '<img class="pic" src="/img/profile04.png" th:alt="${fragment.userName}+\'ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„\'"><p><span class="point-span">'+fragment.userName+'</span>ë‹˜ '
                      if(fragment.total_cnt>1) {
                        b+='<span class="point-span">ì™¸ '+numberFormatting(fragment.total_cnt-1)+'ëª… </span>';
                      }
                      b+='ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</p>';
                    }

                    $("#liked-people" + postId)
                            .html(b);
                  });
        }
        /*]]>*/
      }

      function likeInsert(pid){
        $.ajax({
          url : '/like/insert/' + pid,
          type : 'post',
          success : function(data){
            if(data == 1)
              likeview();
          }
        });
      }

      function likeDelete(pid){
        $.ajax({
          url : '/like/delete/' + pid,
          type : 'post',
          success : function(data){
            if(data == 1)
              likeview();
          }
        });
      }

      function numberFormatting(num)
      {
        var regexp = /\B(?=(\d{3})+(?!\d))/g;
        return num.toString().replace(regexp, ',');
      }

    </script>
</body>
</html>